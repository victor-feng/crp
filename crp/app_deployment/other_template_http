  {% for obj in objs %}

  upstream  {{ obj.project }} {
  {% for ip in obj.ips %}
    server  {{ ip }} max_fails=0;
  {% endfor %}

	check interval=2000 fall=2 rise=2 timeout=1000 default_down=true type=http;
	check_http_send "HEAD /healthz HTTP/1.0\r\n\r\n";
	keepalive 16;
  }
  {% endfor %}

  server {
      listen 80;
      server_name {{ domain }};
      access_log  logs/{{ domain }}.access.log  main;

      {% for obj in objs %}
      location {{ obj.dpath }} {
          proxy_pass http://{{ obj.project }}/;
          proxy_set_header Host             {{ obj.project }};
          proxy_set_header X-Real-IP        $remote_addr;
          proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
          proxy_connect_timeout 60;
          proxy_send_timeout 60;
          proxy_read_timeout 30;
      }
      {% endfor %}
  }

{% for obj in objs %}
#-->{"domain": "{{obj.domain}}", "project": "{{obj.project}}", "dpath": "{{obj.dpath}}", "ips": {{obj.ips}}, "template": "{{obj.template}}", "certificate": "{{obj.certificate}}"}
{% endfor %}
